<!DOCTYPE html>
<html>
<head>
    <title>Progressive Loading Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #dfd; }
        .fail { background: #fdd; }
    </style>
</head>
<body>
    <h1>Progressive Loading Test</h1>
    <div id="results"></div>

    <script>
        // Simulate the key functions from scripts.py
        const expandedNodes = new Set();
        const allNodes = [];
        const allLinks = [];

        function buildTreeStructure() {
            // Simulate building tree with empty children arrays
            allNodes.forEach(node => {
                if (!node.hasOwnProperty('children')) {
                    node.children = [];
                }
            });
        }

        function test(name, fn) {
            const result = document.createElement('div');
            result.className = 'test';
            try {
                fn();
                result.className += ' pass';
                result.innerHTML = `✓ ${name}`;
            } catch (e) {
                result.className += ' fail';
                result.innerHTML = `✗ ${name}<br>${e.message}`;
            }
            document.getElementById('results').appendChild(result);
        }

        // Test 1: Initial state - node with expandable=true, expanded=false should trigger fetch
        test('Initial click on expandable directory should detect needs loading', () => {
            const nodeData = {
                id: 'dir1',
                name: 'src',
                type: 'directory',
                expandable: true,
                expanded: false,
                children: []  // Empty after buildTreeStructure
            };

            // OLD CHECK (broken):
            // const hasLoadedChildren = (nodeData.children && nodeData.children.length > 0) ||
            //                            (nodeData._children && nodeData._children.length > 0);
            // const needsLoading = nodeData.expandable && !nodeData.expanded && !hasLoadedChildren;

            // NEW CHECK (fixed):
            const needsLoading = nodeData.expandable && !nodeData.expanded;

            if (!needsLoading) {
                throw new Error('Should detect node needs loading, but check returned false');
            }
        });

        // Test 2: After expansion - node with expanded=true should NOT trigger fetch again
        test('After expansion, clicking same node should NOT fetch again', () => {
            const nodeData = {
                id: 'dir1',
                name: 'src',
                type: 'directory',
                expandable: true,
                expanded: true,  // Marked as expanded by expandNode()
                children: []  // Still empty array (no actual children)
            };

            const needsLoading = nodeData.expandable && !nodeData.expanded;

            if (needsLoading) {
                throw new Error('Should NOT detect needs loading after expansion, but check returned true');
            }
        });

        // Test 3: Node with children loaded - should NOT fetch again
        test('Node with actual children should NOT fetch again', () => {
            const nodeData = {
                id: 'dir1',
                name: 'src',
                type: 'directory',
                expandable: true,
                expanded: true,
                children: [
                    { id: 'file1', name: 'main.py', type: 'file' }
                ]
            };

            const needsLoading = nodeData.expandable && !nodeData.expanded;

            if (needsLoading) {
                throw new Error('Should NOT detect needs loading when children exist');
            }
        });

        // Test 4: File node behavior (same logic as directory)
        test('File node should use same expanded flag logic', () => {
            const nodeData = {
                id: 'file1',
                name: 'main.py',
                type: 'file',
                expandable: true,
                expanded: false,
                children: []
            };

            const needsLoading = nodeData.expandable && !nodeData.expanded;

            if (!needsLoading) {
                throw new Error('File should detect needs loading on first click');
            }
        });

        // Test 5: Expanded file should not fetch again
        test('Expanded file should NOT fetch chunks again', () => {
            const nodeData = {
                id: 'file1',
                name: 'main.py',
                type: 'file',
                expandable: true,
                expanded: true,
                children: []
            };

            const needsLoading = nodeData.expandable && !nodeData.expanded;

            if (needsLoading) {
                throw new Error('Should NOT fetch chunks again for expanded file');
            }
        });

        // Test 6: Simulate full expand workflow
        test('Full workflow: expand -> mark -> rebuild -> check again', () => {
            // Initial state
            const node = {
                id: 'dir1',
                name: 'src',
                type: 'directory',
                expandable: true,
                expanded: false,
                children: []
            };

            // Step 1: First click - should need loading
            let needsLoading = node.expandable && !node.expanded;
            if (!needsLoading) {
                throw new Error('Step 1 failed: Should need loading on first click');
            }

            // Step 2: Simulate expandNode() - mark as expanded
            expandedNodes.add(node.id);
            node.expanded = true;

            // Step 3: Simulate buildTreeStructure() - recreates empty children arrays
            node.children = [];  // Reset to empty

            // Step 4: Second click - should NOT need loading (even though children is empty)
            needsLoading = node.expandable && !node.expanded;
            if (needsLoading) {
                throw new Error('Step 4 failed: Should NOT need loading after expansion (expanded flag is true)');
            }
        });
    </script>
</body>
</html>
